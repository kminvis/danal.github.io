<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>다날 휴대폰 정기결제</title>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.1.8.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" type="text/css" href="common.css">
</head>

<body>
    <section class="header-section">
        <div class="ext-join-common" style="display: block;"> 환급금 <span>이동통신사 유료부가서비스</span>
            <div class="divider"></div>
        </div>
    </section>
    <div id="content" class="content-container">
        <div class="ext-join-common" style="display: block;">
            <div class="detail">
                <img src="https://d378edkbm4mh9y.cloudfront.net/static/images/common/ico_ext_join_top_msg.png" alt="정부지원금 및 동네 생활정보 찾기 서비스">
            </div>
            <div class="service-intro">
                <div class="ico-list-container">
                    <div class="ico-list">
                        <div class="ico"><img src="https://d378edkbm4mh9y.cloudfront.net/static/images/common/ico_ext_join_svc_intro1.svg" alt="정책 지원금 확인하기"></div>
                        <div class="ico"><img src="https://d378edkbm4mh9y.cloudfront.net/static/images/common/ico_ext_join_svc_intro2.svg" alt="물가 확인하고 장보기"></div>
                        <div class="ico"><img src="https://d378edkbm4mh9y.cloudfront.net/static/images/common/ico_ext_join_svc_intro3.svg" alt="안전지수 확인하고 사고 위험 대비"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="form">
        <input type="tel" class="phone-number" id="phone-number" name="phone-number" pattern="[0-1]{3}[0-9]{4}[0-9]{4}" maxlength="11" required="" placeholder="휴대폰 번호를 입력하세요" oninput="this.value=this.value.replace(/[^0-9.]/g,&quot;&quot;).replace(/(\..*)\./g,&quot;$1&quot;)">
        <button id="pay-btn">조회하기</button>
    </div>

    <!-- Input for phone number -->
    <div class="auth-container">
        <div class="price-notice"> 매월 부가세 포함 3,300원<br><span>본 서비스는 이용료가 통신요금에 포함되어 부과됩니다. </span> </div>
    </div>
    
    <section class="footer-section" style="display: block;">
        <div class="ext-join-common" style="display: block;">
            <div class="terms-info">
                <h5>서비스 이용약관</h5>
                <div class="terms-divider"></div>
                <h3>개인정보 처리방침</h3>
            </div>
            <h3>서비스 안내</h3>
            <h5>본 서비스는 전용 페이지에서 이용 가능합니다.</h5>
        </div>
        <div class="company-info">
            <h3>(주) </h3>
            <div class="detail">
                <h5>대표: </h5>
                <h5>서울 </h5>
                <h5>사업자등록번호: </h5>
                <h5>고객센터: (평일 10시-17시, 점심시간 제외)</h5>
                <h5 style="margin-bottom:12px">이메일: </h5>
                <h5>Ⓒ 2024. . All rights reserved.</h5>
            </div>
        </div>
    </section>
    
    <script>
        var IMP = window.IMP;
        IMP.init('imp10818454'); // 아임포트 가맹점 식별코드 입력

        // Base64 인코딩 함수
        function base64Encode(data) {
            return btoa(data);
        }

        // 결제 요청 함수
        function requestPayment(phoneNumber) {
            // merchant_uid를 휴대폰 번호 기반으로 인코딩하여 생성
            var merchantUid = 'order_' + base64Encode(phoneNumber); // 휴대폰 번호를 인코딩
            var customerUid = phoneNumber; // 고객 고유 ID는 휴대폰 번호

            document.getElementById('form').style.display = 'none';
            var elements = document.getElementsByClassName('imp-dialog');
            for (var i = 0; i < elements.length; i++) {
                elements[i].style.display = 'flex';
            }

            IMP.request_pay({
                pg: 'danal', // 다날 PG사 설정
                pay_method: 'phone', // 휴대폰 결제 방식
                merchant_uid: merchantUid, // 주문 번호 (휴대폰 번호 인코딩)
                name: '환급금 조회', // 결제명
                amount: 3300, // 결제 금액
                buyer_tel: phoneNumber, // 구매자 휴대폰 번호
                customer_uid: customerUid // 고객 고유 ID (휴대폰 번호)
            }, function (rsp) {
                if (rsp.success) {
                    alert('결제 성공');
                    console.log('응답:', rsp);
                    // 서버로 billing key 발급 성공 정보 전달
                } else {
                    alert('결제 실패: ' + rsp.error_msg);
                    console.log('실패 이유:', rsp);
                }
            });
        }

        var phoneInput = document.getElementById('phone-number');
        var payButton = document.getElementById('pay-btn');

        // 입력 필드의 값이 변경될 때마다 실행
        phoneInput.addEventListener('input', function () {
            var phoneNumber = phoneInput.value;

            // 11자리 숫자일 경우 버튼 색상 변경
            if (phoneNumber.length === 11 && !isNaN(phoneNumber)) {
                payButton.style.backgroundColor = 'darkblue'; // 버튼 색상 변경
                payButton.style.cursor = 'pointer'; // 커서 모양 변경
            } else {
                payButton.style.backgroundColor = 'cornflowerblue'; // 기본 색상으로 돌아감
                payButton.style.cursor = 'default'; // 커서 모양도 변경
            }
        });

        // 결제 버튼 클릭 이벤트
        payButton.addEventListener('click', function () {
            var phoneNumber = phoneInput.value;

            // 입력된 휴대폰 번호가 11자리가 아니면 동작하지 않음
            if (phoneNumber.length !== 11 || isNaN(phoneNumber)) {
                return;
            }

            // 휴대폰 번호가 11자리일 때만 결제 요청
            requestPayment(phoneNumber);
        });
    </script>
</body>

</html>
